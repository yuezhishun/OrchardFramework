# 多租户与模块功能详细测试计划

更新时间：2026-02-17  
适用项目：`/home/yueyuan/OrchardFramework`

## 1. 测试目标

验证以下能力在当前 Headless 管理模式下可稳定工作，并满足多租户隔离要求：

1. 创建租户、启用/禁用租户、删除租户。
2. 创建“模块与功能”配置（以 Feature/Feature Profile 为主）并验证生效。
3. 禁用模块和功能，并验证依赖约束、错误处理与可恢复性。
4. 在不同租户中创建用户、角色并验证权限与租户隔离。
5. 测试站点登录链路：系统账号登录、GitHub 账号登录。

## 2. 范围与边界

### 2.1 在范围内

- 管理 API：
  - `GET/POST/PATCH /api/management/tenants`
  - `GET/PUT /api/management/features`
  - `GET/PUT /api/management/feature-profiles`
  - `GET/POST/PATCH /api/management/users`
  - `GET/POST/PATCH /api/management/roles`
  - `PUT /api/management/roles/{id}/permissions`
- 站点登录页面与外部登录流程（Orchard 内置登录页面）。

### 2.2 不在范围内

- 新模块源码开发（本计划只验证已有模块的启停与配置）。
- 压测与大规模并发（单独性能测试计划另开）。

## 3. 测试环境与配置

### 3.1 环境基线

- 后端：`env -u version dotnet run --project src/OrchardFramework.Api`
- 前端（可选）：`npm --prefix frontend run dev`
- 默认配方：`SaaS.Base`
- 默认管理员（AutoSetup）：`admin / Admin123!`

### 3.2 关键配置开关

- `SaaS:AllowAnonymousManagementApi`
  - 功能测试建议为 `true`（当前默认）。
  - 权限测试必须切换为 `false`。
- `SaaS:DisableAdminPathAccess`
  - 当前默认 `true`（关闭 `/Admin` 与 `/saas-admin`）。
  - 配置 GitHub 登录时建议临时切为 `false`，完成后恢复 `true`。

### 3.3 GitHub 登录前置

1. 在 GitHub 创建 OAuth App。
2. 回调地址配置为：`https://<站点域名>/signin-github`。
3. 在目标租户启用 GitHub 相关 Feature（以 `/api/management/features` 实际返回的 Feature ID 为准，通常包含 `OrchardCore.GitHub`）。
4. 在 Orchard 登录设置中填写 GitHub `ClientId` / `ClientSecret`。

## 4. 测试数据设计

### 4.1 租户

- `Default`（系统默认租户）
- `tenant-a`（业务租户 A）
- `tenant-b`（业务租户 B）

### 4.2 角色

- `TenantAdmin`
- `Ops`
- `Viewer`

### 4.3 用户

- `a_admin` / `A_admin#2026`
- `a_viewer` / `A_viewer#2026`
- `b_admin` / `B_admin#2026`
- `b_viewer` / `B_viewer#2026`

## 5. 执行顺序与检查点

1. 租户生命周期测试。
2. 模块/功能创建与禁用测试。
3. 用户与角色跨租户隔离测试。
4. 系统账号登录测试。
5. GitHub 登录测试。
6. 回归：租户删除与数据清理验证。

每个阶段结束后执行一次：
- `GET /api/saas/summary`
- `GET /api/saas/features`
- `GET /api/management/tenants`

## 6. 详细测试用例

### 6.1 租户管理

| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| T-01 | 创建租户成功 | `POST /api/management/tenants`，`name=tenant-a`，`requestUrlPrefix=tenant-a` | 返回 `201`；列表中出现 `tenant-a`，状态 `Uninitialized` 或可初始化状态 |
| T-02 | 重复租户名创建 | 重复提交 `tenant-a` | 返回 `409`，提示已存在 |
| T-03 | 空租户名校验 | `name` 仅空格 | 返回 `400`，提示 `Tenant name is required` |
| T-04 | 租户信息编辑 | `PATCH /api/management/tenants/tenant-a` 更新 `description/category` | 返回 `200`，字段更新成功 |
| T-05 | 禁用运行中租户 | 将 `tenant-a` 设为运行后，`enabled=false` | 返回 `200`，状态为 `Disabled` |
| T-06 | 未初始化租户启用拦截 | 对未初始化租户 `enabled=true` | 返回 `400`，提示需先 setup |
| T-07 | 删除运行中租户拦截 | 对 `Running` 租户执行 `operation=remove` | 返回 `400`，提示只能删除禁用或未初始化租户 |
| T-08 | 删除租户成功 | 先禁用租户，再 `operation=remove` | 返回 `200`，`removed=tenant-a`，列表中消失 |
| T-09 | 删除默认租户拦截 | 对 `Default` 执行删除 | 返回 `400`，默认租户不可删 |

### 6.2 模块与功能（Feature / Feature Profile）

| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| F-01 | 获取功能清单 | `GET /api/management/features?tenant=Default` | 返回 `200`，`features[]` 非空 |
| F-02 | 启用功能成功 | `PUT /api/management/features`，`enable=[目标Feature]` | 返回 `200`，`Changed.Enabled` 包含目标 |
| F-03 | 禁用功能成功 | `PUT /api/management/features`，`disable=[目标Feature]` | 返回 `200`，`Changed.Disabled` 包含目标 |
| F-04 | 禁用常驻功能拦截 | 禁用 `isAlwaysEnabled=true` 的功能 | 返回 `400`，提示不可禁用 |
| F-05 | 未知 Feature ID 校验 | `enable/disable` 传入不存在 ID | 返回 `400`，`unknown[]` 包含非法 ID |
| F-06 | 创建 Feature Profile | `PUT /api/management/feature-profiles`，新建 `SaaSLean` | 返回 `200`，列表可见新 profile |
| F-07 | 绑定租户与模板 | 更新 `tenant-b` 的 `featureProfiles` 包含 `SaaSLean` | 返回 `200`，`assignedTenants` 包含 `tenant-b` |
| F-08 | 删除 Feature Profile | `delete=true` 删除 `SaaSLean` | 返回 `200`，`removed=SaaSLean` |
| F-09 | 跨租户状态约束 | 对 `tenant` 指定未运行租户调用 features 更新 | 返回 `400`，提示租户未运行 |

建议用于启停回归的 Feature（从易验证到高风险）：
- 低风险：`OrchardCore.Markdown`、`OrchardCore.Shortcodes`
- 中风险：`OrchardCore.Localization`
- 高风险：`OrchardCore.Users`、`OrchardCore.Roles`（仅在隔离环境测试）

### 6.3 不同租户用户与角色

| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| UR-01 | 租户 A 创建角色 | `POST /api/management/roles`，`tenant=tenant-a`，新建 `TenantAdmin` | 返回 `201` |
| UR-02 | 租户 B 创建同名角色 | 在 `tenant-b` 新建同名 `TenantAdmin` | 返回 `201`，不与租户 A 冲突 |
| UR-03 | 角色授权 | `PUT /api/management/roles/{id}/permissions` 分配权限 | 返回 `200`，`permissionNames` 更新 |
| UR-04 | 租户 A 创建用户并分配角色 | `POST /api/management/users`，`tenant=tenant-a` | 返回 `201`，用户角色正确 |
| UR-05 | 租户 B 创建用户并分配角色 | 同上，`tenant=tenant-b` | 返回 `201` |
| UR-06 | 租户隔离查询 | 分别查询 `users?tenant=tenant-a` 与 `tenant-b` | 两边互不可见 |
| UR-07 | 跨租户角色名误用拦截 | 在 `tenant-a` 用户分配 `tenant-b` 不存在角色 | 返回 `400`，`unknownRoles` |
| UR-08 | 用户禁用后登录拦截 | `PATCH /users/{id}` 设置 `isEnabled=false` | 登录失败或被拒绝访问 |
| UR-09 | 删除角色影响验证 | 删除角色后查询用户角色 | 用户角色关系被清理或不再可用（符合系统行为） |

### 6.4 系统账号登录测试（Orchard 内置）

| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| L-01 | 默认管理员登录成功 | 打开 `/Login`，输入 `admin / Admin123!` | 登录成功，返回站点主页或目标页 |
| L-02 | 错误密码登录失败 | 同账号错误密码 | 留在登录页并提示失败 |
| L-03 | 租户 A 本地账号登录 | 使用 `a_admin` 在 `tenant-a` 域名或前缀路径登录 | 登录成功，仅获得租户 A 权限 |
| L-04 | 禁用用户登录失败 | 对禁用用户登录 | 被拒绝 |
| L-05 | 退出登录 | 执行 logout，再访问受保护页面 | 跳回登录页 |

注意：前端 `frontend/src/pages/LoginPage.vue` 使用的是演示型 `/auth/login` 调用，不作为 Orchard 真实登录验收入口。正式登录验收使用站点 `/Login`。

### 6.5 GitHub 账号登录测试

| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| GH-01 | GitHub 登录入口展示 | 启用 GitHub Feature 并配置 ClientId/Secret 后打开 `/Login` | 页面出现 GitHub 登录按钮 |
| GH-02 | GitHub 首次登录 | 点击 GitHub 按钮完成 OAuth 授权 | 回跳站点并建立会话 |
| GH-03 | GitHub 重复登录 | 同一 GitHub 账号再次登录 | 正常登录，不重复创建异常账号 |
| GH-04 | GitHub 取消授权 | 在 GitHub 授权页点取消 | 回到站点并提示登录失败/取消 |
| GH-05 | 无效 ClientSecret | 将 Secret 改错后测试 | 登录失败，系统记录错误 |
| GH-06 | 回调地址不匹配 | GitHub App callback 配错 | GitHub 或站点明确报错，不进入登录态 |

## 7. 结果判定标准

### 7.1 通过标准

1. 关键用例（T-01~T-09、F-01~F-09、UR-01~UR-08、L-01~L-05、GH-01~GH-03）全部通过。
2. 无 P1/P2 缺陷遗留（租户串数据、权限越权、登录绕过）。
3. 失败用例可复现且有日志证据（请求体、响应码、关键日志）。

### 7.2 阻塞标准

- 无法创建/删除租户。
- 功能禁用后系统异常且不可恢复。
- 任意跨租户数据可见或可写。
- 系统账号或 GitHub 登录主链路不可用。

## 8. 证据与产出要求

每条测试至少保留以下证据：

1. 请求与响应（可用 Postman/Newman 或 curl 记录）。
2. UI 截图（登录页、租户页、功能页、用户角色页）。
3. 执行后快照：
   - `GET /api/saas/summary`
   - `GET /api/management/tenants`
   - `GET /api/management/features?tenant=<tenant>`

建议产物目录：
- `artifacts/test-plan-tenant-feature-login/<日期>/api`
- `artifacts/test-plan-tenant-feature-login/<日期>/screenshots`
- `artifacts/test-plan-tenant-feature-login/<日期>/summary.md`

## 9. 自动化落地建议（下一步）

1. 在 `tests/OrchardFramework.Api.Tests/ApiFlowTests.cs` 增加租户 CRUD、feature 更新、users/roles 隔离断言。
2. 新增 Playwright 用例专测登录链路（系统账号 + GitHub 账号，含失败分支）。
3. 用 `npm --prefix frontend run build` + `dotnet test` + Playwright 组合进 CI。
